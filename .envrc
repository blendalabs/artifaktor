source .venv/bin/activate

# Runtime linker paths for pip wheels on NixOS + NVIDIA driver access for torch CUDA
# Try standard driver path first, then fall back to libglvnd from /nix/store.
GL_PATH="/run/opengl-driver/lib"
if [ ! -e "$GL_PATH/libGL.so.1" ]; then
  # Pick a 64-bit libglvnd candidate from /nix/store (ELF class 2).
  GL_PATH="$({
    python - <<'PY'
import glob, os
for cand in sorted(glob.glob('/nix/store/*-libglvnd-*/lib')):
    p = os.path.join(cand, 'libGL.so.1')
    if not os.path.exists(p):
        continue
    with open(p, 'rb') as f:
        hdr = f.read(5)
    if len(hdr) >= 5 and hdr[4] == 2:  # ELFCLASS64
        print(cand)
        break
PY
  } 2>/dev/null)"
fi
QT_LIB_DIRS="$({
  python - <<'PY'
import glob, os
need = [
    'libGL.so.1',
    'libEGL.so.1',
    'libxkbcommon.so.0',
    'libxkbcommon-x11.so.0',
    'libX11.so.6',
    'libxcb.so.1',
    'libxcb-cursor.so.0',
    'libxcb-icccm.so.4',
    'libxcb-util.so.1',
    'libxcb-image.so.0',
    'libxcb-keysyms.so.1',
    'libxcb-render-util.so.0',
    'libfontconfig.so.1',
    'libfreetype.so.6',
    'libglib-2.0.so.0',
    'libgthread-2.0.so.0',
    'libdbus-1.so.3',
    'libwayland-client.so.0',
    'libwayland-cursor.so.0',
]

def is_elf64(path: str) -> bool:
    try:
        with open(path, 'rb') as f:
            hdr = f.read(5)
        return len(hdr) >= 5 and hdr[4] == 2
    except Exception:
        return False

out = []
for lib in need:
    picked = None
    for p in sorted(glob.glob(f'/nix/store/*/lib/{lib}')):
        if is_elf64(p):
            picked = os.path.dirname(p)
            break
    if picked and picked not in out:
        out.append(picked)
print(':'.join(out))
PY
} 2>/dev/null)"
# Always include the NVIDIA driver path for CUDA (libcuda.so.1, libnvidia-*.so)
NVIDIA_DRIVER_PATH="/run/opengl-driver/lib"
export LD_LIBRARY_PATH="${NVIDIA_DRIVER_PATH}:${GL_PATH}${QT_LIB_DIRS:+:$QT_LIB_DIRS}${NIX_LD_LIBRARY_PATH:+:$NIX_LD_LIBRARY_PATH}${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"

export LABEL_STUDIO_USERNAME=admin@localhost
export LABEL_STUDIO_PASSWORD=admin
export LABEL_STUDIO_URL=http://127.0.0.1:8080

# Label Studio local-files storage settings (required)
export LOCAL_FILES_SERVING_ENABLED=true
export LOCAL_FILES_DOCUMENT_ROOT=/home/adam/CODE/blenda/artifaktor

# Backward-compatible alias used in some docs/scripts
export LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/home/adam/CODE/blenda/artifaktor

# Prefer local RTX 4080 GPU for Grounding DINO inference
export GROUNDING_DINO_DEVICE=cuda

# Force YOLO training on GPU (auto-detect fails under NixOS app launcher)
export ARTIFAKTOR_TRAIN_DEVICE=cuda

# Iterative LS retrain loop (label -> Train -> Retrieve Predictions)
export SEQUENCE_LEARNING_ENABLED=true
export SEQUENCE_PREFER_TRAINED=true
export SEQUENCE_MIN_TRAIN_SAMPLES=8
export SEQUENCE_K_NEIGHBORS=4

# Prevent long-lived stale locks if the UI/tab glitches
export TASK_LOCK_TTL=300

# Prefer Wayland Qt plugin; can be overridden per-shell if needed.
export QT_QPA_PLATFORM=${QT_QPA_PLATFORM:-wayland}

# Transparent warm-start wrapper:
# `label-studio start ...` will warm the ML backend first, then launch LS.
label-studio() {
  if [ "${1:-}" = "start" ]; then
    shift
    ./scripts/start_label_studio.sh "$@"
  else
    ./.venv/bin/label-studio "$@"
  fi
}
